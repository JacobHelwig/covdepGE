---
output: pdf_document
---

# Data Generation

## Extraneous covariate

$Z$ is generated as the union of three disjoint intervals with nearly adjacent endpoints. That is, $Z = Z_1 \cup Z_2 \cup Z_3$ with $Z_1 = (a,b), Z_2 = (c,d), Z_3 = (m,n)$. Within each interval, the individuals' covariate values are equally spaced. 

## Precision matrix

All of the individuals in interval 1 have the same precision matrix, $\Omega^{(1)}$: 

\[\Omega^{(1)}_{i,j} = 
\begin{cases}
2 & i = j \\
1 & (i,j)\in\{(1, 2), (2,1),(2,3),(3,2)\} \\
0 & o.w.
\end{cases}\]

Also, all of the individuals in interval 3 have the same precision matrix, $\Omega^{(3)}$:

\[\Omega^{(3)}_{i,j} = 
\begin{cases}
2 & i = j \\
1 & (i,j)\in\{(1,3), (3,1),(2,3),(3,2)\} \\
0 & o.w.
\end{cases}\]

But, the individuals in interval 2 have a precision matrix that is dependent upon $Z$ and $(d, c)$. Let $\beta_0 = -c / (d-c)$ and $\beta_1 = 1 / (d - c)$. Then:

\[\Omega^{(2)}_{i,j}(z) = 
\begin{cases}
2 & i = j \\
1 & (i,j)\in\{(2,3), (3,2)\} \\
1 - \beta_0 - \beta_1z & (i,j)\in \{(1,2), (2,1)\} \\
\beta_0 + \beta_1z & (i,j)\in\{(1,3),(3,1)\}\\
0 & o.w.
\end{cases}
\]

Thus, $\Omega^{(2)}(c) = \Omega^{(1)}$ and $\Omega^{(2)}(d) = \Omega^{(3)}$. That is, the first individual in interval 2 has precision matrix $\Omega^{(1)}$ and the last individual in interval 2 has precision matrix $\Omega^{(3)}$.

## Data matrix

Let $z_l$ be the extraneous covariate for the $l$-th individual. To generate the data matrix for the $l$-th individual, a random sample is taken from $\mathcal N (0,\Omega_l^{-1})$, where: \[\Omega_l(z_l) = 
\begin{cases}
\Omega^{(1)} & z_l\in Z_1 \\
\Omega^{(2)}(z_l) & z_l \in Z_2 \\
\Omega^{(3)} & z_l \in Z_3
\end{cases}
\]

# Sensitivity Analysis

## Overview

The goal of this analysis will be to examine the necessary signal strength in the interval 2 precision matrices to obtain nearly perfect structure recovery. To increase the signal strength, in each trial, I will further decrease the number of individuals in the second interval. Since the covariate values are uniformly spaced, this will result in larger jumps between the covariate values, which will result in greater signal strength. 

That is, let $z^{(k)}_{2,l}$ be the value of the extraneous covariate for the $l$-th individual in interval 2 on the $k$-th trial. Then, $z_{2,l}^{(k)}\leq z_{2,l}^{(k + 1)}$, with equality only for the first and last individuals in interval 2. Then, it follows that: 

\[\beta_0 + \beta_1 z_{2,l}^{(k)}\leq \beta_0 + \beta_1z_{2,l}^{(k + 1)}\implies \Omega_{1, 3}^{(2)}(z_{2,l}^{(k)})\leq\Omega_{1, 3}^{(2)}(z_{2,l}^{(k + 1)})\]

## Trial 1

\[n_2 = 60\]

```{r, echo = F, message = F, fig.width = 6, fig.height = 6}
library(covdepGE)
library(ggpubr)
library(ggplot2)
library(kableExtra)

setwd("~/TAMU/Research/An approximate Bayesian approach to covariate dependent/covdepGE/dev")
source("generate_data.R")
n1 <- n2 <- n3 <- 60
n <- sum(n1, n2, n3)
cont <- generate_continuous(1, n1, n2, n3)
data_mat <- cont$data
Z <- cont$covts

cov_df <- cbind.data.frame(interval = rep(1:3, each = 60), Z, 
                           individual_index = 1:n)

# individual index by interval
ind_idx <- tapply(cov_df$individual_index, cov_df$interval, function(
  indices) paste0("$", min(indices), ",\\ldots,", max(indices), "$"))
kbl(tibble::tibble("Interval" = names(ind_idx), "Individual Indices" = ind_idx), 
    booktabs = T, linesep = "", align = "c", escape = F) %>% kable_styling(
      latex_options = c("striped", "HOLD_position")) %>% column_spec(1:2, width = "4.5cm")

int2_g_inds <- n1 + 1:4
int2_graphs <- lapply(int2_g_inds, function(indv_idx) 
  gg_adjMat(cont$true_precision[[indv_idx]]) +
    labs(title = paste0("Individual ", indv_idx)))
annotate_figure(ggarrange(plotlist = int2_graphs, common.legend = T), 
                top = text_grob("First 4 Precision Matrices for Interval 2", size = 15))
```

```{r, fig.width = 10, fig.height = 6}
out <- covdepGE(data_mat, Z, var_min = 1e-6, var_max = 1, n_sigma = 20, CS = T, 
                parallel = T, num_workers = 7, stop_cluster = F)
out
colors <- c("steelblue", "goldenrod", "forestgreen", "tomato2", "dodgerblue", 
            "darkorchid", "powderblue", "seagreen", "turqoise", "springgreen2")
annotate_figure(ggarrange(plotlist = plot(out, colors)), 
                text_grob("Unique Graphs, trial 1", size = 15))
```

*Results look slightly different than before since I am setting * `CS = T`, *which uses Carbonetto-Stephens model to specify * $\sigma^2$ and $\pi$. *Also, I am using less grid points.*

## Trial 2

\[n_2 = 30\]

```{r, echo = F, message = F, fig.width = 6, fig.height = 6}
n2 <- 30
n <- sum(n1, n2, n3)
cont <- generate_continuous(1, n1, n2, n3)
data_mat <- cont$data
Z <- cont$covts

cov_df <- cbind.data.frame(interval = c(rep(1, n1), rep(2, n2), rep(3, n3)), Z, 
                           individual_index = 1:n)

# individual index by interval
ind_idx <- tapply(cov_df$individual_index, cov_df$interval, function(
  indices) paste0("$", min(indices), ",\\ldots,", max(indices), "$"))
kbl(tibble::tibble("Interval" = names(ind_idx), "Individual Indices" = ind_idx), 
    booktabs = T, linesep = "", align = "c", escape = F) %>% kable_styling(
      latex_options = c("striped", "HOLD_position")) %>% column_spec(1:2, width = "4.5cm")

int2_g_inds <- n1 + 1:4
int2_graphs <- lapply(int2_g_inds, function(indv_idx) 
  gg_adjMat(cont$true_precision[[indv_idx]]) +
    labs(title = paste0("Individual ", indv_idx)))
annotate_figure(ggarrange(plotlist = int2_graphs, common.legend = T), 
                top = text_grob("First 4 Precision Matrices for Interval 2", size = 15))
```

```{r, fig.width = 10, fig.height = 6}
out <- covdepGE(data_mat, Z, var_min = 1e-6, var_max = 1, n_sigma = 20, CS = T, 
                parallel = T, stop_cluster = F)
out
annotate_figure(ggarrange(plotlist = plot(out, colors)), 
                text_grob("Unique Graphs, trial 2", size = 15))
```

## Trial 3

\[n_2 = 10\]

```{r, echo = F, message = F, fig.width = 6, fig.height = 6}
n2 <- 10
n <- sum(n1, n2, n3)
cont <- generate_continuous(1, n1, n2, n3)
data_mat <- cont$data
Z <- cont$covts

cov_df <- cbind.data.frame(interval = c(rep(1, n1), rep(2, n2), rep(3, n3)), Z, 
                           individual_index = 1:n)

# individual index by interval
ind_idx <- tapply(cov_df$individual_index, cov_df$interval, function(
  indices) paste0("$", min(indices), ",\\ldots,", max(indices), "$"))
kbl(tibble::tibble("Interval" = names(ind_idx), "Individual Indices" = ind_idx), 
    booktabs = T, linesep = "", align = "c", escape = F) %>% kable_styling(
      latex_options = c("striped", "HOLD_position")) %>% column_spec(1:2, width = "4.5cm")

int2_g_inds <- n1 + 1:4
int2_graphs <- lapply(int2_g_inds, function(indv_idx) 
  gg_adjMat(cont$true_precision[[indv_idx]]) +
    labs(title = paste0("Individual ", indv_idx)))
annotate_figure(ggarrange(plotlist = int2_graphs, common.legend = T), 
                top = text_grob("First 4 Precision Matrices for Interval 2", size = 15))
```

```{r, fig.width = 10, fig.height = 8}
out <- covdepGE(data_mat, Z, var_min = 1e-6, var_max = 1, n_sigma = 20, CS = T, 
                parallel = T, stop_cluster = F)
out
annotate_figure(ggarrange(plotlist = plot(out, colors)), 
                text_grob("Unique Graphs, trial 3", size = 15))
```

## Trial 4

\[n_2 = 5\]

```{r, echo = F, message = F, fig.width = 6, fig.height = 6}
n2 <- 5
n <- sum(n1, n2, n3)
cont <- generate_continuous(1, n1, n2, n3)
data_mat <- cont$data
Z <- cont$covts

cov_df <- cbind.data.frame(interval = c(rep(1, n1), rep(2, n2), rep(3, n3)), Z, 
                           individual_index = 1:n)

# individual index by interval
ind_idx <- tapply(cov_df$individual_index, cov_df$interval, function(
  indices) paste0("$", min(indices), ",\\ldots,", max(indices), "$"))
kbl(tibble::tibble("Interval" = names(ind_idx), "Individual Indices" = ind_idx), 
    booktabs = T, linesep = "", align = "c", escape = F) %>% kable_styling(
      latex_options = c("striped", "HOLD_position")) %>% column_spec(1:2, width = "4.5cm")

int2_g_inds <- n1 + 1:4
int2_graphs <- lapply(int2_g_inds, function(indv_idx) 
  gg_adjMat(cont$true_precision[[indv_idx]]) +
    labs(title = paste0("Individual ", indv_idx)))
annotate_figure(ggarrange(plotlist = int2_graphs, common.legend = T), 
                top = text_grob("First 4 Precision Matrices for Interval 2", size = 15))
```

```{r, fig.width = 10, fig.height = 8}
out <- covdepGE(data_mat, Z, var_min = 1e-6, var_max = 1, n_sigma = 20, CS = T, 
                parallel = T, stop_cluster = F)
out
annotate_figure(ggarrange(plotlist = plot(out, colors)), 
                text_grob("Unique Graphs, trial 4", size = 15))
```

## Trial 5

\[n_2 = 4\]

```{r, echo = F, message = F, fig.width = 6, fig.height = 6}
n2 <- 4
n <- sum(n1, n2, n3)
cont <- generate_continuous(1, n1, n2, n3)
data_mat <- cont$data
Z <- cont$covts

cov_df <- cbind.data.frame(interval = c(rep(1, n1), rep(2, n2), rep(3, n3)), Z, 
                           individual_index = 1:n)

# individual index by interval
ind_idx <- tapply(cov_df$individual_index, cov_df$interval, function(
  indices) paste0("$", min(indices), ",\\ldots,", max(indices), "$"))
kbl(tibble::tibble("Interval" = names(ind_idx), "Individual Indices" = ind_idx), 
    booktabs = T, linesep = "", align = "c", escape = F) %>% kable_styling(
      latex_options = c("striped", "HOLD_position")) %>% column_spec(1:2, width = "4.5cm")

int2_g_inds <- n1 + 1:n2
int2_graphs <- lapply(int2_g_inds, function(indv_idx) 
  gg_adjMat(cont$true_precision[[indv_idx]]) +
    labs(title = paste0("Individual ", indv_idx)))
annotate_figure(ggarrange(plotlist = int2_graphs, common.legend = T), 
                top = text_grob("Interval 2 Precision Matrices", size = 15))
```

```{r, fig.width = 10, fig.height = 8}
out <- covdepGE(data_mat, Z, var_min = 1e-6, var_max = 1, n_sigma = 20, CS = T, 
                parallel = T, stop_cluster = F)
out
annotate_figure(ggarrange(plotlist = plot(out, colors)), 
                text_grob("Unique Graphs, trial 5", size = 15))
```

## Trial 6

\[n_2 = 3\]

```{r, echo = F, message = F, fig.width = 6, fig.height = 6}
n2 <- 3
n <- sum(n1, n2, n3)
cont <- generate_continuous(1, n1, n2, n3)
data_mat <- cont$data
Z <- cont$covts

cov_df <- cbind.data.frame(interval = c(rep(1, n1), rep(2, n2), rep(3, n3)), Z, 
                           individual_index = 1:n)

# individual index by interval
ind_idx <- tapply(cov_df$individual_index, cov_df$interval, function(
  indices) paste0("$", min(indices), ",\\ldots,", max(indices), "$"))
kbl(tibble::tibble("Interval" = names(ind_idx), "Individual Indices" = ind_idx), 
    booktabs = T, linesep = "", align = "c", escape = F) %>% kable_styling(
      latex_options = c("striped", "HOLD_position")) %>% column_spec(1:2, width = "4.5cm")

int2_g_inds <- n1 + 1:n2
int2_graphs <- lapply(int2_g_inds, function(indv_idx) 
  gg_adjMat(cont$true_precision[[indv_idx]]) +
    labs(title = paste0("Individual ", indv_idx)))
annotate_figure(ggarrange(plotlist = int2_graphs, common.legend = T), 
                top = text_grob("Interval 2 Precision Matrices", size = 15))
```

```{r, fig.width = 10, fig.height = 8}
out <- covdepGE(data_mat, Z, var_min = 1e-6, var_max = 1, n_sigma = 20, CS = T, 
                parallel = T, stop_cluster = F)
out
annotate_figure(ggarrange(plotlist = plot(out, colors)), 
                text_grob("Unique Graphs, trial 6", size = 15))
```
