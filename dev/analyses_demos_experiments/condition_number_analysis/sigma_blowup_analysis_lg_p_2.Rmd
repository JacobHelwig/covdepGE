---
title: "sigma blowup analysis 2, large p"
output: pdf_document
toc: true
---

```{r, echo = F}
knitr::opts_knit$set(root.dir = "~/TAMU/Research/An approximate Bayesian approach to covariate dependent/covdepGE/dev/analyses_demos_experiments/condition_number_analysis")
knitr::opts_chunk$set(fig.width = 11, fig.height = 4.5, echo = F, error = T, warning = F, message = F)
```

# Experiment Overview

In this experiment, I analyze the behavior of the `covdepGE` algorithm when applied to a large dataset. Specifically, I have observed that in the large $p$ regime, the MAPE-fitted $\sigma^2$ values blow up along with the $\mu$ values, and so, the purpose of this analysis is to more closely examine this blowup. 

I perform 100 trials on data generated as described in the section titled *Data Generation* with $p + 1= 25$. For each variable, I allowed each CAVI 1,000 iterations to converge during the grid search for optimal $\pi$. Additional grid searches were performed until stability in the optimal $\pi$ value was attained. $\pi$ was selected by maximizing ELBO over the following grid:

\[\underset\sim\pi = \{0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45\}\]

$\sigma^2$ and $\sigma^2_\beta$ were both fit to the data using MAPE.

In the *Results* section, I analyze the frequency and patterns of the blowups and the condition numbers associated with the blowups.  

# Data Generation

## Extraneous Covariate

```{r}
colors <- c("chartreuse3", "chocolate2", "cornflowerblue", "darkgoldenrod1", 
            "darkmagenta", "deepskyblue3", "forestgreen", "darkorchid3", 
            "darkred", "darkslategray")


# function for generating the data and the covariates
generate_continuous <- function(n1 = 60, n2 = 60, n3 = 60, p = 4){

  # create covariate for individuals in each of the three intervals
  
  # define the dimensions of the data
  n <- sum(n1, n2, n3)
  
  # define the limits of the intervals
  limits1 <- c(-3, -1)
  limits2 <- c(-1, 1)
  limits3 <- c(1, 3)
  
  # define the covariate values within each interval
  z1 <- runif(n1, limits1[1], limits1[2])
  z2 <- runif(n2, limits2[1], limits2[2])
  z3 <- runif(n3, limits3[1], limits3[2])
  Z <- matrix(sort(c(z1, z2, z3)), n, 1)
  
  # create precision matrices
  
  # the shared part of the structure for all three intervals is a 2 on the
  # diagonal and a 1 in the (2, 3) position
  common_str <- diag(p + 1)
  common_str[2, 3] <- 1
  
  # define constants for the structure of interval 2
  beta1 <- diff(limits2)^-1
  beta0 <- -limits2[1] * beta1
  
  # interval 2 has two different linear functions of Z in the (1, 2) position
  # and (1, 3) positions; define structures for each of these components
  int2_str12 <- int2_str13 <- matrix(0, p + 1, p + 1)
  int2_str12[1, 2] <- int2_str13[1, 3] <- 1
  
  # define the precision matrices for each of the individuals in interval 2
  int2_prec <- lapply(z2, function(z) common_str +
                        ((1 - beta0 - beta1*z)*int2_str12) +
                        ((beta0 + beta1*z)*int2_str13))
  
  # interval 1 has a 1 in the (1, 2) and interval 3 has a 1 in the (1, 3) position;
  # define structures for each of these components
  int1_str12 <- int3_str13 <- matrix(0, p + 1, p + 1)
  int1_str12[1, 2] <- int3_str13[1, 3] <- 1
  
  # define the precision matrices for each of the individuals in interval 1 and interval 3
  int1_prec <- rep(list(common_str + int1_str12), n1)
  int3_prec <- rep(list(common_str + int3_str13), n3)
  
  # put all of the precision matrices into one list
  prec_mats <- c(int1_prec, int2_prec, int3_prec)
  
  # symmetrize the precision matrices
  prec_mats <- lapply(prec_mats, function(mat) t(mat) + mat)
  
  # invert the precision matrices to get the covariance matrices
  cov_mats <- lapply(prec_mats, solve)
  
  # generate the data using the covariance matrices
  data_mat <- t(sapply(cov_mats, MASS::mvrnorm, n = 1, mu = rep(0, p + 1)))
  
  return(list(data = data_mat, covts = Z, true_precision = prec_mats))
}

library(covdepGE)
library(latex2exp)
library(ggpubr)
```

I generated the covariate, $Z$, as the union of three almost disjoint intervals of equal measure. That is, $Z = Z_1 \cup Z_2 \cup Z_3$ with $Z_1 = (-3, -1), Z_2 = (a,b) = (-1, 1), Z_3 = (1, 3)$. Within each interval, I generated 60 covariate values from a uniform distribution. For example: 

```{r}
cont <- generate_continuous(p = 24)
X <- cont$data
Z <- cont$covts
n <- nrow(X)
p <- ncol(X) - 1

interval <- c(rep(1, 60), rep(2, 60), rep(3, 60))
cov_df <- cbind.data.frame(interval = interval, Z, individual_index = 1:n)
cov_df$interval <- factor(cov_df$interval)
ggplot(cov_df, aes(Z, fill = interval)) +
  geom_histogram(color = "black", binwidth = 0.2) +
  theme_classic() +
  ggsci::scale_fill_jco() +
  labs(title = ("Distribution of Covariate")) +
  theme(plot.title = element_text(hjust = 0.5))
```

## Precision Matrix

All of the individuals in interval 1 had the same precision matrix, $\Omega^{(1)}$: 

\[\Omega^{(1)}_{i,j} = 
\begin{cases}
2 & i = j \\
1 & (i,j)\in\{(1, 2), (2,1),(2,3),(3,2)\} \\
0 & o.w.
\end{cases}\]

Also, all of the individuals in interval 3 had the same precision matrix, $\Omega^{(3)}$:

\[\Omega^{(3)}_{i,j} = 
\begin{cases}
2 & i = j \\
1 & (i,j)\in\{(1,3), (3,1),(2,3),(3,2)\} \\
0 & o.w.
\end{cases}\]

However, the individuals in interval 2 had a precision matrix that was dependent upon $Z$ and $(a, b)$. Let $\beta_0 = -a / (b - a)$ and $\beta_1 = 1 / (b - a)$. Then:

\[\Omega^{(2)}_{i,j}(z) = 
\begin{cases}
2 & i = j \\
1 & (i,j)\in\{(2,3), (3,2)\} \\
1 - \beta_0 - \beta_1z & (i,j)\in \{(1,2), (2,1)\} \\
\beta_0 + \beta_1z & (i,j)\in\{(1,3),(3,1)\}\\
0 & o.w.
\end{cases}
\]

Thus, $\Omega^{(2)}(a) = \Omega^{(1)}$ and $\Omega^{(2)}(b) = \Omega^{(3)}$. That is, an individual on the left or right boundary of $Z_2$ would have precision matrix $\Omega^{(1)}$ or $\Omega^{(3)}$, respectively. The conditional dependence structures corresponding to each of these precision matrices are visualized below.

```{r, fig.height = 9}
# get the true graphs
true_graphs <- lapply(cont$true_precision, function(prec_mat) (prec_mat - diag(diag(prec_mat)) != 0) * 1)

# get the unique true graphs
strs <- unique(true_graphs)

# get the individual indices corresponding to each of the structures
ind_idx <- lapply(strs, function(strc) which(sapply(true_graphs, identical, strc)))

# get the summary for each 
ind_sum <- sapply(ind_idx, function(idx) paste0(min(idx), ",...,", max(idx)))

# visualize each of the structures
str_viz <- lapply(1:length(strs), function(strc_idx) 
  gg_adjMat(strs[[strc_idx]], color1 = colors[strc_idx]) +
    ggtitle(paste("Individuals ", ind_sum[strc_idx])))
ggarrange(plotlist = str_viz)
```

## Data matrix

Let $z_l$ be the extraneous covariate for the $l$-th individual. To generate the data matrix for the $l$-th individual, I took a random sample from $\mathcal N (0,\{\Omega_l(z_l)\}^{-1})$, where: \[\Omega_l(z_l) = 
\begin{cases}
\Omega^{(1)} & z_l\in Z_1 \\
\Omega^{(2)}(z_l) & z_l \in Z_2 \\
\Omega^{(3)} & z_l \in Z_3
\end{cases}
\]

# Results

## Distribution of MAPE fitted $\sigma^2$

I first analyze the distribution of the MAPE-fitted $\sigma^2$. There are 100 trials, each with 25 variables; for each variable, $n = 180$ weighted regressions are fit. Thus, there are $100 * 25 * 180 = 450,000$ fitted $\sigma^2$. Of these, 797 "blew up" - that is, had a value exceeding 15. 

Of the $\sigma^2$ that did not blow up, the largest value was roughly 13 - these $\sigma^2$ are all contained in the first bin of the log-log histogram. Of those that did blow up, the smallest value was on the order of $1e33$. 

Note that the spike at the maximum value occurs from imputing 360 `NA` values resulting from `Inf / Inf` as the maximum value.

```{r}
library(ggplot2)
library(latex2exp)
load("~/TAMU/Research/An approximate Bayesian approach to covariate dependent/covdepGE/dev/analyses_demos_experiments/condition_number_analysis/cond_number_models.Rda")

# get dimensions of the data
dt_dim <- dim(results$trial1$data$data)
n <- dt_dim[1]; p <- dt_dim[2]
n_trials <- length(results)

# get all of the summaries
summs <- lapply(results, `[[`, "results")

# find the sigmasq for each model
ssq <- lapply(lapply(summs, `[[`, "hyperparameters"), `[[`, "sigmasq")

# unfold the sigmasq matrices into a n_trials x p nested list of n-vectors
ssq_nest <- lapply(1:n_trials, function(trial_ind) lapply(1:p, function(var_ind) ssq[[trial_ind]][ , var_ind]))
names(ssq_nest) <- paste0("trial", 1:n_trials)
for (j in 1:n_trials) names(ssq_nest[[j]]) <- paste0("variable", 1:p)

# find ssq that are blown: either NA or in excess of 15
blown_sig <- lapply(ssq_nest, lapply, function(sigma) (sigma > 15 | is.na(sigma)))

max(unlist(ssq_nest)[!unlist(blown_sig)])
min(unlist(ssq_nest)[unlist(blown_sig)], na.rm = T)
length(unlist(ssq_nest))
sum(unlist(blown_sig))
impute_missing <- rep(max(unlist(ssq_nest), na.rm = T), sum(is.na(unlist(ssq_nest))))
sum(is.na(unlist(ssq_nest)))

# find the values of the blown sigmasq
ggplot(data.frame(ssq = sort(c(na.omit(unlist(ssq_nest)), impute_missing))), aes(ssq)) +
  geom_histogram(color = "black", fill = "tomato3") +
  scale_x_continuous(trans = "log10", n.breaks = 15) + scale_y_continuous(trans = "log10", n.breaks = 8) +
  theme_bw() + ggtitle(TeX("Distribution of the MAPE fitted $\\sigma^2$")) +
  xlab(TeX("$\\sigma^2$")) + theme(plot.title = element_text(hjust = 0.5))
```

## Breaking down the blowups

Here, I look at the blowups broken down by trial. Of the 100 trials, 17 had at least one indvidual whose $\sigma^2$ value blew up. The maximum number of variables that blew up occured in trial 86, when 7 of the 25 variables had at least 1 individual that blew up. Trials having 0 blowups are omitted from this figure. 

```{r}
# find counts of individuals by variable and trial
blown_ct_var <- lapply(blown_sig, sapply, sum)

# find counts by trials of variables with blown sigmas
blown_ct_tr <- sapply(blown_ct_var, function(ssq) sum(ssq > 0))

# logical for trials with at least one blown variable
blown_trials <- blown_ct_tr > 0
sum(blown_trials)

# visualize the counts of the number of variables that blew up for each trial
blown_tr_df <- data.frame(sort(blown_ct_tr[blown_trials]))
blown_tr_df$trial <- factor(sapply(strsplit(row.names(blown_tr_df), "trial"), `[[`, 2))
blown_tr_df$trial <- factor(blown_tr_df$trial, levels = blown_tr_df$trial)
names(blown_tr_df)[1] <- "blowups"
ggplot(blown_tr_df, aes(trial, blowups, fill = trial)) + geom_bar(stat = "identity") +
  theme_bw() + ggtitle("Number of variables with blowups by trial") + theme(plot.title = element_text(hjust = 0.5)) +
  ggsci::scale_fill_igv() + guides(fill = "none")
```

Breaking this down even further, the following histogram shows the number of individuals per variable per trial that blew up. Variables with 0 blowups are omitted here.

The maximum number of individuals to blow up for a single variable occurred in trial 43 for variable 18, with 51 individuals blowing up. The minimum occurred in trial 32 for variable 17, with just 2 individuals blowing up. 

```{r}
# find blown individual indices for each variable
blown_inds <- lapply(blown_sig[blown_trials], sapply, which)
blown_inds_len <- lapply(blown_inds, lapply, length)
bl_inds_len0 <- unlist(blown_inds_len)[unlist(blown_inds_len) != 0]

# filter out the zero length variables from blown_inds
blown_inds0 <- lapply(blown_inds, function(trial) trial[sapply(trial, function(variable) length(variable) > 0)])
tr_var_cts <- sapply(unlist(blown_inds0, F), length)
tr_var_names <- strsplit(names(tr_var_cts), split = "\\.")
tr_var_df <- cbind.data.frame(t(sapply(tr_var_names, c)), tr_var_cts)
row.names(tr_var_df) <- NULL
colnames(tr_var_df) <- c("Trial", "Variable", "Number of individuals that blew up")
tr_var_df$var_num <- factor(sapply(strsplit(tr_var_df$Variable, "variable"), `[[`, 2))
tr_var_df$tr_num <- factor(sapply(strsplit(tr_var_df$Trial, "trial"), `[[`, 2), levels = levels(blown_tr_df$trial))
tr_var_df$label <- paste0("Trial ", tr_var_df$tr_num, ", Variable ", tr_var_df$var_num)
tr_var_df$label <- factor(tr_var_df$label, levels = tr_var_df$label)
ggplot(tr_var_df, aes(label, `Number of individuals that blew up`, fill = tr_num)) +
  geom_bar(stat = "identity") + ggsci::scale_fill_igv() +
  guides(fill = "none") + xlab("Trial and variable number") +
  ggtitle("Number of Individuals that blew up by trial and variable number") + theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
summary(bl_inds_len0)
which.min(bl_inds_len0)
which.max(bl_inds_len0)
```

## Condition number analysis

### Raw data

The following shows the distribution of the condition numbers of the matrices in trials that had at least one individual that blew up, versus those in which no individuals blew up. That these distributions have no striking differences in shape motivates a further analysis of the weighted matrices.

```{r}
# all of the data
datas <- lapply(results, `[[`, "data")

# all of the data mats
data_mats <- lapply(datas, `[[`, "data")

# all data matrices with/ without at least one blown ind
blown_mats <- data_mats[blown_trials]
unblown_mats <- data_mats[!blown_trials]

# find the condition number for both
blown_cond_nums <- sapply(blown_mats, kappa)
unblown_cond_nums <- sapply(unblown_mats, kappa)
ggplot(data.frame(condition_number = blown_cond_nums),aes(condition_number)) +
  geom_histogram(color = "black", fill = "tomato3", binwidth = 0.1) + theme_bw() +
  ggtitle("Distribution of condition numbers for data with at least one blowup (unweighted)") +
  theme(plot.title = element_text(hjust = 0.5)) + coord_cartesian(xlim = c(2.9, 4.3))
summary(blown_cond_nums)
ggplot(data.frame(condition_number = unblown_cond_nums),aes(condition_number)) +
  geom_histogram(color = "black", fill = "forestgreen", binwidth = 0.1) + theme_bw() +
  ggtitle("Distribution of condition numbers for data with no blowups (unweighted)") +
  theme(plot.title = element_text(hjust = 0.5)) + coord_cartesian(xlim = c(2.9, 4.3))
summary(unblown_cond_nums)
```

### Weighted data

As mentioned in the section analyzing the distribution of the MAPE-fitted $\sigma^2$, there were 797 individuals that blew up. Thus, there are 797 unique weighted matrices corresponding to these individuals. In this section, I analyze the condition number of these matrices, as well as the remaining $450,000 - 797$ that did not blow up.

The distribution of the condition numbers for the matrices that blew up demonstrates a greater center than those that did not blow up. Thus, this suggests that the cause of the blowup is associated with the weights, since there was no difference in the condition numbers of the raw data.

```{r}
# find the weights
wts <- lapply(summs, `[[`, "weights")

# find the square root of the weights
wts_2 <- lapply(wts, sqrt)

# find the weighted data_mats for everyone
wted_mats <- lapply(1:n_trials, function(tr_ind)
  lapply(1:p, function(var_ind)
    lapply(1:n, function(indv_ind) wts_2[[tr_ind]][ , indv_ind] * data_mats[[tr_ind]][ , -var_ind])))

# length(wted_mats)
# length(wted_mats[[1]])
# length(wted_mats[[1]][[1]])
#
# length(blown_sig)
# length(blown_sig[[1]])
# length(blown_sig[[1]][[1]])

# find the weighted matrices corresponding to the individuals that did and did not blow up
blown_wt_mat <- lapply(1:n_trials, function(trial_ind)
  lapply(1:p, function(var_ind) wted_mats[[trial_ind]][[var_ind]][blown_sig[[trial_ind]][[var_ind]]]))
unblown_wt_mat <- lapply(1:n_trials, function(trial_ind)
  lapply(1:p, function(var_ind) wted_mats[[trial_ind]][[var_ind]][!blown_sig[[trial_ind]][[var_ind]]]))
for (trial_ind in 1:n_trials){
  for (var_ind in 1:p){
    if (length(blown_wt_mat[[trial_ind]][[var_ind]]) > 0){
      names(blown_wt_mat[[trial_ind]][[var_ind]]) <- paste0("individual", which(blown_sig[[trial_ind]][[var_ind]]))
    }
    names(unblown_wt_mat[[trial_ind]][[var_ind]]) <- paste0("individual", which(!blown_sig[[trial_ind]][[var_ind]]))
  }
}
# length(unlist(unlist(blown_wt_mat, F), F))
# sum(unlist(blown_sig))
# length(unlist(unlist(unblown_wt_mat, F), F))
# sum(!unlist(blown_sig))

# unlist the blown and unblown mats so that the list consists just of matrices
blown_wt_mat2 <- unlist(unlist(blown_wt_mat, F), F)
unblown_wt_mat2 <- unlist(unlist(unblown_wt_mat, F), F)

# find the condition number for each of the blown up matrices
blown_cond <- sapply(blown_wt_mat2, kappa)
unblown_cond <- sapply(unblown_wt_mat2, kappa)
ggplot(data.frame(condition_number = blown_cond), aes(condition_number)) +
  geom_histogram(color = "black", fill = "tomato3", binwidth = 0.25) + theme_bw() +
  ggtitle("Distribution of condition numbers for weighted matrices that blew up") +
  theme(plot.title = element_text(hjust = 0.5)) + coord_cartesian(xlim = c(2.8, 9))
summary(blown_cond)
ggplot(data.frame(condition_number = unblown_cond), aes(condition_number)) +
  geom_histogram(color = "black", fill = "forestgreen", binwidth = 0.25) + theme_bw() +
  ggtitle("Distribution of condition numbers for weighted matrices that did not blow up") +
  theme(plot.title = element_text(hjust = 0.5)) + coord_cartesian(xlim = c(2.8, 9))
summary(unblown_cond)
```

### Individual breakdown

Since it appears that the increased condition numbers are associated with individual-specific weights, I now look at the blowups on an individual level. 

Since each individual has $100 * 25 = 2,500$ unique weighted matrices, I calculate the condition number for each of these matrices and then display the distribution of the median condition number for each individual. As can be seen, individuals with the lowest and highest indices (which corresponds to being on the extremes of the covariate interval) have the greatest condition numbers.

```{r}
# collect weighted matrices by individual
wt_mats2500 <- unlist(wted_mats, F)
wt_mat_indv <- lapply(1:n, function(indv_ind) lapply(1:(n_trials * p), function (ind25) wt_mats2500[[ind25]][[indv_ind]]))

# calculate the condition number for each of these matrices
cond_num_indv_180 <- lapply(wt_mat_indv, sapply, kappa)

# calculate the median condition number for each of the individuals
med_cond_num_180 <- sapply(cond_num_indv_180, median)

# visualize these condition numbers
ggplot(data.frame(Individual = 1:n, median_condition_number = med_cond_num_180), aes(
  Individual, median_condition_number)) + geom_bar(stat = "identity", fill = "tomato3") + theme_bw() +
  ggtitle("Median Condition Number By Individual") + theme(plot.title = element_text(hjust = 0.5)) +
  coord_cartesian(ylim = c(4.5, 6)) + scale_x_continuous(breaks = c(1, seq(10, 180, 10)), labels = c(1, seq(10, 180, 10)))
```

I now display the counts of the blowups for each individual. Note that each individual had $100 * 25 = 2,500$ opportunities to blow up; the greatest number of blowups was achieved by individual 171, with 25. 

From the previous and following figures, it is clear that as median condition number increases, so does the tendency to blow up. 

```{r}
# find all of the unique individuals that had at least one blown up sigmasq
blown_indvs <- sort(unique(unlist(blown_inds)))
length(blown_indvs)
# table(unlist(blown_inds))

# vizualize the counts of these individuals
blown_ct_df <- data.frame(table(unlist(blown_inds)))
blown_ct_df$Var1 <- as.numeric(as.character(blown_ct_df$Var1))
new_rows <- cbind(setdiff(1:n, blown_ct_df$Var1), 0)
colnames(new_rows) <- colnames(blown_ct_df)
blown_ct_df <- rbind.data.frame(blown_ct_df, new_rows)
names(blown_ct_df) <- c("Individual", "Number of Blow Ups")
ggplot(blown_ct_df, aes(Individual, `Number of Blow Ups`)) +
  geom_bar(stat = "identity", fill = "tomato3") +
  ggtitle("Number of Blowups by Individual") + theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = c(1, seq(10, 180, 10)), labels = c(1, seq(10, 180, 10)))
```

### Blown-up individual breakdown

I finally restrict my attention to just the individuals that blew up at least one time. There are 79 such individuals. Across the 2,500 opportunities for a given individual to blow up, I first calculate the mean condition number for the matrices corresponding to the times when this individual did blow up, and then compare this to the mean condition number for when this individual did not blow up. 

I then take the pairwise difference for each of these individuals; that is, for a given individual, I subtract the mean blown-up condition number from the mean non-blown up condition number. I would expect this difference to be positive on average, however, this is not the trend that I observed, suggesting that there is more at play than just the condition number of the weighted matrices. 

```{r}
# var 14, trial 86
# tr86_wt_mat <- lapply(1:n, function(var_ind) data_mats[[86]][ , -14] * wts_2[[86]][ , var_ind])
# tr86_conds <- sapply(tr86_wt_mat, kappa)
# ggplot(data.frame(Individual = 1:n, condition_number = tr86_conds), aes(Individual, condition_number)) +
#   geom_bar(stat = "identity", fill = "tomato3") + coord_cartesian(ylim = c(4.2, 6.1)) +
#   theme_bw() + ggtitle("Condition Number by Individual, Trial 86, Variable 14") +
#   theme(plot.title = element_text(hjust = 0.5))

# for each of the individuals who has blown up, find the matrices corresponding
# to the variables where they blew up and where they did not blow up
blown_indvs_blow_mats <- lapply(blown_indvs, function(indv_idx)
  lapply(1:n_trials, function(trial_ind)
    lapply(1:p, function(var_ind) blown_wt_mat[[trial_ind]][[var_ind]][paste0("individual", indv_idx)])))
names(blown_indvs_blow_mats) <- paste0("individual", blown_indvs)
blown_indvs_unblow_mats <- lapply(blown_indvs, function(indv_idx)
  lapply(1:n_trials, function(trial_ind)
    lapply(1:p, function(var_ind) unblown_wt_mat[[trial_ind]][[var_ind]][paste0("individual", indv_idx)])))
names(blown_indvs_unblow_mats) <- paste0("individual", blown_indvs)

indv_171_blow_mats <- unlist(unlist(blown_indvs_blow_mats[["individual171"]], F), F)
#length(indv_171_blow_mats[!sapply(indv_171_blow_mats, is.null)])

#indv_1_blow_mats <- unlist(unlist(blown_indvs_blow_mats[[1]], F), F)
# length(indv_1_blow_mats[!sapply(indv_1_blow_mats, is.null)])
# sum(unlist(blown_inds) == 1)

# find condition numbers for each of the matrices
blown_indvs_blow_conds <- lapply(blown_indvs_blow_mats, lapply, lapply, lapply,
                                 function(mat) if (!is.null(mat)) kappa(mat))
blown_indvs_unblow_conds <- lapply(blown_indvs_unblow_mats, lapply, lapply, lapply,
                                   function(mat) if (!is.null(mat)) kappa(mat))

# # visualize these
# ggplot(data.frame(condition_numbers = unlist(blown_indvs_blow_conds)), aes(condition_numbers)) +
#   geom_histogram(binwidth = 0.25, color = "black", fill = "tomato3") +
#   ggtitle("Condition numbers for matrices that blew up for individuals that blew up") +
#   theme_bw() + theme(plot.title = element_text(hjust = 0.5)) + coord_cartesian(xlim = c(3, 9))
# summary(unlist(blown_indvs_blow_conds))
# ggplot(data.frame(condition_numbers = unlist(blown_indvs_unblow_conds)), aes(condition_numbers)) +
#   geom_histogram(binwidth = 0.25, color = "black", fill = "forestgreen") +
#   ggtitle("Condition numbers for matrices that did not blow up for individuals that blew up") +
#   theme_bw() + theme(plot.title = element_text(hjust = 0.5)) + coord_cartesian(xlim = c(3, 9))
# summary(unlist(blown_indvs_unblow_conds))

# summary(unlist(blown_indvs_blow_conds[["individual171"]]))
# summary(unlist(blown_indvs_unblow_conds[["individual171"]]))

# find condition numbers for each of the individuals with nulls removed
blown_indvs_blow_conds2 <- lapply(blown_indvs_blow_conds, unlist)
blown_indvs_unblow_conds2 <- lapply(blown_indvs_unblow_conds, unlist)

# find medians for each
# med_blow_conds <- sapply(blown_indvs_blow_conds2, median)
# med_unblow_conds <- sapply(blown_indvs_unblow_conds2, median)
# round(med_blow_conds - med_unblow_conds, 2)

# find means for each
mean_blow_conds <- sapply(blown_indvs_blow_conds2, mean)
mean_unblow_conds <- sapply(blown_indvs_unblow_conds2, mean)
ggplot(data.frame(X = mean_blow_conds - mean_unblow_conds), aes(X)) +
  geom_histogram(binwidth = .05, color = "black", fill = "forestgreen") + theme_bw() +
  ggtitle("Condition number for blown up matrices minus non-blown up matrices by individual") +
  theme(plot.title = element_text(hjust = 0.5)) + xlab("Condition number")
summary(mean_blow_conds - mean_unblow_conds)
```

### Individual 171

I finally display the distribution of the blown-up condition numbers versus the non-blown up condition numbers for a single individual. I selected individual 171, since this individual blew up more than any other indvidual - in the 2,500 opportunities to blow up, this individual blew up a total of 25 times.

```{r}
# visualize the condition numbers for individual 171
ggplot(data.frame(blown_indvs_blow_conds2["individual171"]), aes(individual171)) +
  geom_histogram(binwidth = 0.25, color = "black", fill = "tomato3") + theme_bw() +
  ggtitle("Condition number for matrices that blew up, individual 171") +
  theme(plot.title = element_text(hjust = 0.5)) + coord_cartesian(xlim = c(4, 9))
ggplot(data.frame(blown_indvs_unblow_conds2["individual171"]), aes(individual171)) +
  geom_histogram(binwidth = 0.25, color = "black", fill = "forestgreen") + theme_bw() +
  ggtitle("Condition number for matrices that did not blow up, individual 171") +
  theme(plot.title = element_text(hjust = 0.5))
```
